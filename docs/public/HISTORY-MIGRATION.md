# Public History Migration Runbook

This runbook defines how we compare and cut over public history for `graphiti-openclaw`.

## Migration candidates

1. **filtered-history**
   - Preserve more existing history.
   - Apply boundary allowlist/denylist policy to detect leakage risk.
   - Higher review burden when ambiguous or blocked paths remain.
2. **clean-foundation**
   - Start from a minimal curated root commit.
   - Prioritize long-term maintainability and lower merge conflict risk.

## Decision rule (locked)

Use `scripts/public_history_scorecard.py` and apply this machine-checkable rule:

- Choose **clean-foundation** automatically if **either**:
  - filtered-history weighted score `< 80`, or
  - any unresolved `HIGH` finding remains after one remediation pass.
- Otherwise, choose the higher weighted score.

This keeps maintainability/safety ahead of history preservation.

## Reproducible dry-run workflow

Run from repository root:

```bash
python3 scripts/public_history_export.py --mode filtered-history --dry-run
python3 scripts/public_history_export.py --mode clean-foundation --dry-run
python3 scripts/public_history_scorecard.py \
  --filtered-report reports/publicization/filtered-history.md \
  --clean-report reports/publicization/clean-foundation.md \
  --out reports/publicization/history-scorecard.md
```

Outputs:
- candidate reports: `reports/publicization/{filtered-history,clean-foundation}.md`
- candidate summaries: `reports/publicization/{filtered-history,clean-foundation}.json`
- final scorecard: `reports/publicization/history-scorecard.md`

## Branch plan

- Filtered candidate branch: `cutover/filtered-history`
- Clean candidate branch: `cutover/clean-foundation`

Current scorecard winner should be treated as the default cutover branch unless a new run changes scores.

## Cutover safety protocol

1. `git fetch origin`
2. Create winner branch and perform candidate-specific rewrite/snapshot steps.
3. Push winner branch for review first (do **not** overwrite `main` directly).
4. Record pre-cutover SHA (`git rev-parse origin/main`) and tag it (`pre-cutover-main`).
5. After approval, execute force push with lease to `main`.

Rollback command format:

```bash
git push --force-with-lease origin <pre-cutover-sha>:main
```

## Author metadata

- Preserve authored-by metadata as generated by git history tooling.
- If any private identity appears during review, stop cutover and remediate before push.
